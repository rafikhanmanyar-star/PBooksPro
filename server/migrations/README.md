# Database Migrations

## Migrations Run on Startup

These run automatically when the API starts (see `scripts/run-migrations-on-startup.ts`):

- `postgresql-schema.sql` — base schema
- `add-payment-tables.sql`
- `add-bill-version-column.sql`
- `add-p2p-tables.sql`
- `add-target-delivery-date.sql`
- `add-user-id-to-transactions.sql`
- `make-audit-log-user-id-nullable.sql`
- `add-org-id-to-rental-agreements.sql`
- `add-contact-id-to-rental-agreements.sql`
- `add-tasks-schema.sql` (creates tasks + task_updates + task_performance_* if missing; adds missing columns)
- `fix-tasks-missing-title-description.sql` (adds title, description, user_id, etc. when tasks has legacy schema)
- `add-payslips-columns-legacy.sql` (adds payroll_run_id, basic_pay, etc. when legacy payslips exists)
- `add-is-supplier-to-tenants.sql`
- `add-whatsapp-integration.sql`
- `increase-max-users-to-20.sql`
- `add-installment-plan-fields.sql`
- `add-installment-plan-approval-fields.sql` (approval_requested_by, approval_requested_to, etc.; fixes production GET filter)
- `add-sale-recognized-status.sql`
- `add-plan-amenities-table.sql` (plan_amenities + discount/amenity columns on installment_plans)
- `add-installment-plan-to-project-agreements.sql`
- `add-unit-fields.sql`

Plus inline migrations (e.g. `license_history.payment_id`, tenant supplier columns).

All of these are **additive and idempotent** (safe to run multiple times).

---

## ⛔ Never Run on Production

These migrations **drop tables**, **delete data**, or **recreate schemas**.  
**Do not** run them against the production database:

| File | Risk |
|------|------|
| `remove-payroll-tables.sql` | DROPs payroll tables |
| `remove-payroll-departments-table.sql` | DROPs payroll_departments |
| `remove-payroll-test-data.sql` | DELETEs payroll data |
| `recreate-tasks-schema.sql` | DROPs tasks tables and recreates |
| `debug-whatsapp-verify-token.sql` | DELETE FROM whatsapp_configs |

They are **not** run by the startup migration runner.

---

## Other Migrations

- **`sync-staging-to-production.sql`** — Generated by `npm run sync-staging` to sync staging with production schema. Use only when **staging** is behind **production**.
- **`production-upgrade-from-staging.sql`** — Generated by `npm run generate-production-upgrade`. Compares **staging** vs **production** and produces additive SQL (missing tables/columns) to run **on production**. Use when production is behind staging.
- **`add-payslips-columns-legacy.sql`** — Adds new payslips columns (payroll_run_id, basic_pay, gross_pay, net_pay, etc.) when the **legacy** payslips table exists. Idempotent. Run on production when upgrading from old payroll schema.

---

## Production Upgrade

See **`doc/PRODUCTION_UPGRADE_FROM_STAGING.md`** for the full guide (backup, merge, deploy, verification, rollback).
