---
name: Import Export System Revamp
overview: Revamp the import/export system to align with the new PostgreSQL database schema, update import templates, and create a CSV export system with user-selectable data types accessible from the settings page.
todos:
  - id: update-import-schemas
    content: Update importSchemas.ts to match PostgreSQL database schema, excluding ID fields (IDs will be auto-generated during import)
    status: completed
  - id: update-import-service
    content: Update importService.ts to handle new schema fields, generate new IDs for all imported records, handle tenant_id assignment, and ensure imports work without data migration
    status: completed
    dependencies:
      - update-import-schemas
  - id: update-import-templates
    content: Update template generation in importService.ts to reflect new schema requirements for all import types, excluding ID fields from templates
    status: completed
    dependencies:
      - update-import-schemas
  - id: create-csv-export-service
    content: Create csvExportService.ts with base CSV generation functions, proper escaping, and progress tracking
    status: completed
  - id: create-csv-export-schemas
    content: Create csvExportSchemas.ts with export schemas for all data types, excluding ID fields, including relationship name resolution
    status: completed
  - id: implement-csv-exports
    content: Implement CSV export functions for each data type in csvExportService.ts using the schemas, ensuring ID fields are excluded from exports
    status: completed
    dependencies:
      - create-csv-export-service
      - create-csv-export-schemas
  - id: create-export-modal
    content: Create ExportDataModal.tsx component with data type selection (grouped by categories), format selection, and export button
    status: completed
  - id: add-export-to-settings
    content: Add export button/link to SettingsPage.tsx that opens the ExportDataModal
    status: completed
    dependencies:
      - create-export-modal
  - id: wire-export-functionality
    content: Connect ExportDataModal to csvExportService, handle user selections, and trigger exports with progress tracking
    status: completed
    dependencies:
      - create-export-modal
      - implement-csv-exports
  - id: test-import-export
    content: Test import/export for all data types, verify tenant isolation, test with large datasets, and handle edge cases
    status: pending
    dependencies:
      - update-import-service
      - wire-export-functionality
---

# I

mport/Export System Revamp Plan

## Overview

This plan revamps the import/export functionality to:

1. Update import templates to match the new PostgreSQL database schema
2. Ensure imports work without data migration in this version
3. Create a CSV export system with user-selectable data types
4. Add export functionality to the settings page with a selection modal

## Current State Analysis

### Import System

- Uses Excel format (.xlsx) with multiple sheets
- Supports multiple import types via `ImportType` enum
- Has import schemas defined in `services/importSchemas.ts`
- Import service in `services/importService.ts` (2835 lines)
- Import page at `components/settings/ImportPage.tsx`

### Export System

- Currently exports all data to Excel format
- Export service in `services/exportService.ts`
- Export schemas in `services/exportSchemas.ts`
- No user selection - exports everything

### Database Schema

- PostgreSQL-based with tenant isolation
- All tables have `tenant_id` column
- Schema defined in `server/migrations/postgresql-schema.sql`

## Required Changes

### 1. Update Import Templates and Schemas

**Files to Update:**

- `services/importSchemas.ts` - Update schemas to match PostgreSQL schema
- `services/importService.ts` - Update import logic to handle new schema fields
- Ensure all import types match the user's requirements:

1. All Contacts
2. Vendors (subset of Contacts)
3. Categories (expense and income)
4. Bill payment transactions
5. Invoice payment transactions
6. Loan Transactions
7. Transfer transactions
8. Projects
9. Buildings
10. Units
11. Properties

**Key Changes:**

- **Exclude ID fields from import templates** - IDs will be auto-generated by the system during import
- Ensure `tenant_id` is handled correctly (should be auto-assigned, not imported)
- Update field mappings to match PostgreSQL column names
- Ensure foreign key relationships are resolved using names (not IDs) during import
- Add validation for required fields per the new schema (excluding ID fields)
- Import service must generate new unique IDs for all imported records

### 2. Create CSV Export System

**New Files to Create:**

- `services/csvExportService.ts` - New CSV export service
- `components/settings/ExportDataModal.tsx` - Modal for selecting data types to export
- `services/csvExportSchemas.ts` - CSV export schemas for each data type

**Files to Update:**

- `components/settings/SettingsPage.tsx` - Add export button/link
- `services/exportService.ts` - Refactor to support both Excel and CSV export

**Export Data Types (Complete List):**

1. Bills
2. Invoices
3. Contracts
4. Agreements (Rental & Project)
5. Transactions (all types)
6. Loan Transactions
7. Transfer Transactions
8. Investment data (Equity Transactions)
9. PM Management data (PM Cycle Allocations)
10. Contacts (each type separate: Vendors, Tenants, Owners, Staff, etc.)
11. Projects
12. Buildings
13. Units
14. Properties
15. Vendors
16. **Additional types found in schema:**

    - Quotations
    - Documents
    - Employees (Enterprise Payroll)
    - Payroll Cycles
    - Payslips (Enterprise)
    - Bonus Records
    - Payroll Adjustments
    - Loan/Advance Records
    - Attendance Records
    - Tax Configurations
    - Statutory Configurations
    - Sales Returns
    - Accounts
    - Salary Components
    - Recurring Invoice Templates
    - Budgets
    - Tasks

### 3. Export Selection UI

**Component Structure:**

```javascript
ExportDataModal
├── Data Type Selection (Checkboxes grouped by category)
│   ├── Financial Documents
│   ├── Master Data
│   ├── Projects & Properties
│   ├── Agreements & Contracts
│   ├── Payroll & HR
│   └── Other
├── Export Format Selection (CSV/Excel)
└── Export Button
```

**Categories for UI:**

- **Financial Documents:** Bills, Invoices, Transactions, Loan Transactions, Transfer Transactions, Investment Data
- **Master Data:** Contacts (all types), Vendors, Accounts, Categories
- **Projects & Properties:** Projects, Buildings, Units, Properties
- **Agreements & Contracts:** Contracts, Rental Agreements, Project Agreements, Sales Returns
- **Payroll & HR:** Employees, Payroll Cycles, Payslips, Bonus Records, Payroll Adjustments, Loan/Advance Records, Attendance Records, Tax Configurations, Statutory Configurations
- **PM Management:** PM Cycle Allocations
- **Other:** Quotations, Documents, Recurring Invoice Templates, Budgets, Tasks, Salary Components

### 4. CSV Export Implementation

**CSV Export Service Features:**

- Generate CSV files for selected data types
- Handle large datasets efficiently
- Include proper headers matching database schema (excluding ID fields)
- **Exclude ID fields from exports** - IDs are system-generated and not needed for re-import
- Export relationships using names (not IDs) for readability
- Support date formatting
- Handle special characters and commas in data
- Create separate CSV files for each selected data type OR combine into one file with multiple sheets (if Excel) or separate files (if CSV)

**Export Format Decision:**

- User can choose: CSV (separate files per type) or Excel (single file with multiple sheets)
- Default: CSV for individual types, Excel for "Export All"

### 5. Database Integration

**Key Considerations:**

- All exports must respect tenant isolation (only export current tenant's data)
- Use database repositories to fetch data
- Handle relationships properly (e.g., export contact names instead of IDs)
- Ensure data consistency (export related data together when needed)

## Implementation Steps

### Phase 1: Update Import System

1. Review and update `importSchemas.ts` to match PostgreSQL schema (exclude ID fields)
2. Update `importService.ts` to handle new schema fields and generate IDs for all imported records
3. Remove ID fields from import templates generation
4. Test import for each data type to ensure IDs are properly generated
5. Update import templates generation to exclude ID fields

### Phase 2: Create CSV Export Infrastructure

1. Create `csvExportService.ts` with base CSV generation functions
2. Create `csvExportSchemas.ts` with schemas for each data type (excluding ID fields)
3. Implement CSV export for each data type (excluding ID fields)
4. Add progress tracking for large exports

### Phase 3: Build Export UI

1. Create `ExportDataModal.tsx` component
2. Add export button to Settings page
3. Implement data type selection with categories
4. Add format selection (CSV/Excel)
5. Wire up export functionality

### Phase 4: Testing & Refinement

1. Test export for each data type
2. Test import with exported data
3. Verify tenant isolation
4. Test with large datasets
5. Handle edge cases and errors

## ID Handling Strategy

### Import Process

- **No ID fields in import templates** - Users will not provide IDs when importing data
- **System-generated IDs** - All imported records will receive new unique IDs generated by the system
- **Relationship resolution** - Foreign key relationships will be resolved using names (e.g., "Contact Name", "Project Name") instead of IDs
- **ID generation** - Use the same ID generation strategy as the application (typically UUID or timestamp-based IDs)

### Export Process

- **Exclude ID fields** - ID fields will not be included in exported CSV/Excel files
- **Relationship names** - Export relationships using human-readable names (e.g., "Contact Name" instead of contact_id)
- **Re-import compatibility** - Exported data can be re-imported without ID conflicts since new IDs will be generated

### Benefits

- **Simplified import** - Users don't need to manage or provide IDs
- **No ID conflicts** - Prevents issues when importing data from different systems
- **Cleaner templates** - Import templates are simpler without ID fields
- **Data portability** - Exported data can be imported into any instance without ID conflicts

## Technical Details

### CSV Export Format

- Use proper CSV escaping (quotes for fields with commas, double quotes for quotes)
- Include headers in first row (excluding ID fields)
- Use consistent date format (YYYY-MM-DD)
- Handle null/empty values appropriately
- Export relationships as names (e.g., "Contact Name" instead of contact_id)
- **Do not export ID fields** - IDs are system-generated and will be created during import

### Import Template Updates

- Update all templates to match new schema
- **Exclude ID fields from templates** - IDs will be auto-generated during import
- Include all required fields (excluding ID fields)
- Provide example data
- Add validation rules documentation
- Ensure import service generates new unique IDs for each imported record

### Error Handling

- Validate selected data types before export
- Show progress for large exports
- Handle export errors gracefully
- Provide clear error messages

## Files to Create/Modify

### New Files

- `services/csvExportService.ts`
- `services/csvExportSchemas.ts`
- `components/settings/ExportDataModal.tsx`

### Modified Files

- `services/importSchemas.ts`
- `services/importService.ts`
- `services/exportService.ts`
- `components/settings/SettingsPage.tsx`
- `components/settings/ImportPage.tsx` (if needed for template updates)

## Dependencies

- Existing: XLSX library for Excel, database repositories
- New: CSV generation (can use native JavaScript or a lightweight library)

## Success Criteria

1. All import templates match the new database schema (excluding ID fields)
2. Imports work without requiring data migration
3. **All imported records receive new system-generated IDs**
4. Users can select specific data types for export